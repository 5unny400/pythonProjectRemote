### 流量复制 `mirror`

> nginx 1.13.4及后续版本内置ngx_http_mirror_module模块，提供流量镜像(复制)的功能。

nginx流量复制将请求同时发送到正式和测试环境，两者不会有任何交集。

> 镜像地址的响应不会返回到请求者，请求者仍然接收主体地址的响应

访问 `http://127.0.0.1/time` 会同时请求 `http://127.0.0.1:81/time` 和 `http://127.0.0.1:82/time`

```
location / {
    # 主体地址
    proxy_pass http://127.0.0.1:81;
    # 流量复制
    mirror /mirror;
}

# 镜像站点
location /mirror {
    # internal 标志该location只为内部的重定向服务， 外面来的返回404
    internal;
    # 设置镜像地址
    # $request_uri 需要显示指明，因为流量复制过来之后会丢掉request_uri
    proxy_pass http://127.0.0.1:82$request_uri;
}
```

---

> 下面的未测试通过

```
location /test/ {
    # 主体地址
    proxy_pass http://127.0.0.1:81/;
    # 流量复制
    mirror /mirror;
    mirror_request_body on;
}

# 镜像站点
location /mirror {
    # internal 标志该location只为内部的重定向服务， 外面来的返回404
    internal;
    # 设置镜像地址
    # $request_uri 需要显示指明，因为流量复制过来之后会丢掉request_uri
    proxy_pass http://127.0.0.1:82$request_uri;
    proxy_pass_request_body on;
    proxy_set_header X-Original-URI $request_uri;
}
```
