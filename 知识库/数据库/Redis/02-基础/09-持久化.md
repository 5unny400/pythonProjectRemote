# 持久化

## RDB

内存快照
恢复速度快,持久化性能高.但是存在数据丢失风险
可每小时备份一次rdb文件数据到自己的数据中心防止数据丢失


### 启用快照

redis.conf

```shell
# 触发时间策略  
# 格式：save <seconds> <changes>
# 可设置多个
# 900秒内，如果超过1个key被修改，则发起快照保存
save 900 1
# 300秒内，如果超过10个key被修改，则发起快照保存
save 300 10
# 60秒内，如果1万个key被修改，则发起快照保存
save 60 10000


# 文件名称
dbfilename dump.rdb


# 文件保存路径，AOF文件同样存放在此目录下。默认为当前工作目录。
dir ./


# 如果持久化出错，主进程是否停止写入操作，yes->停止 => 为了保护持久化的数据一致性问题
stop-writes-on-bgsave-error yes


# 是否压缩
rdbcompression yes


# 导入时是否检查
rdbchecksum yes
```

会产生一个`dump.rdb`文件

### 禁用快照

redis.conf

```shell
save ""
```

### 手动生成快照


#### SAVE

使用同步的方式生成RDB快照文件，在这个过程中会阻塞所有其他客户端的请求，直到RDB文件被创建完毕。 -- 线上应该禁止使用

```shell
save
```

#### BGSAVE

派生(fork)一个子进程来创建新的RDB文件，记录接收到BGSAVE当时的数据库状态，
父进程继续处理接收到的命令，子进程完成文件的创建之后，会发送信号给父进程，
而与此同时，父进程处理命令的同时，通过轮询来接收子进程的信号。

```shell
bgsave
# 查看操作是否成功
lastsave
```

## AOF

日志文件追加记录
实时持久化,数据安全性更高.持久化效率低
当aof文件过大时，会进行重写，即命令压缩(根据类型使用一条命令来替代之前的键值对多条命令)

### 启用AOF

redis.conf

```shell
# 是否开启aof
appendonly yes

# 文件存放目录，与RDB共用。默认为当前工作目录。
dir ./

# 文件名称
appendfilename "appendonly.aof"


# 同步方式
# always：   每次操作都会立即写入aof文件中
# everysec： 每秒持久化一次(默认配置)
# no：       由操作系统决定，一般而言为了提高效率，操作系统会等待缓存区被填满，才会开始同步数据到磁盘。
appendfsync everysec


# 重写触发配置
# Redis会记住自从上一次重写后AOF文件的大小（如果自Redis启动后还没重写过，则记住启动时使用的AOF文件的大小）。
# 如果当前的文件大小比起记住的那个大小超过指定的百分比，则会触发重写。
# 同时需要设置一个文件大小最小值，只有大于这个值文件才会重写，以防文件很小，但是已经达到百分比的情况。
auto-aof-rewrite-percentage 100
# 禁用自动的日志重写功能 -- 百分比设置为0
# auto-aof-rewrite-percentage 0
auto-aof-rewrite-min-size 64mb


# aof重写期间是否同步
no-appendfsync-on-rewrite no
```



---

# 其它

两种方式的持久化是可以同时存在的，但是当Redis重启时，AOF文件会被优先用于重建数据。
